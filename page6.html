<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í’ˆì§ˆê´€ë¦¬ ì‹œìŠ¤í…œ - ë¶€ì¬ ì œì‘ ì˜¤ì°¨</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <script defer src="assets/js/script.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="header-title">Prefab í’ˆì§ˆê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <p class="header-subtitle">ë¶€ì¬ ì œì‘ ì˜¤ì°¨ ì¸¡ì • ë° ë¹„êµ</p>
        </div>
    </header>

    <nav class="page-nav">
        <div class="container">
            <ul>
                <li><a href="index.html">1. ì¢…í•© ìš”ì•½</a></li>
                <li><a href="page2.html">2. í’ˆì§ˆê´€ë¦¬ì ì„¤ë¬¸</a></li>
                <li><a href="page3.html">3. ê°€ì†ë„ ë°ì´í„°</a></li>
                <li><a href="page4.html">4. ê¸°ìš¸ê¸° ë°ì´í„°</a></li>
                <li><a href="page5.html">5. ë³€í˜•ë¥  ë°ì´í„°</a></li>
                <li><a href="page6.html" class="active">6. ë¶€ì¬ ì œì‘ ì˜¤ì°¨</a></li>
                <li><a href="dashboard.html">7. ì¢…í•© ëŒ€ì‹œë³´ë“œ</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <div class="alert alert-info">
            <strong>ğŸ“ ì œì‘ ì˜¤ì°¨ ì¸¡ì • ì•ˆë‚´</strong>
            <p style="margin-top: 0.5rem;">
                Prefab ë¶€ì¬ì˜ ì„¤ê³„ì¹˜ì™€ ì‹¤ì œ ì¸¡ì •ì¹˜ë¥¼ ë¹„êµí•˜ì—¬ ì œì‘ ì˜¤ì°¨ë¥¼ íŒŒì•…í•©ë‹ˆë‹¤. 
                í—ˆìš© ë²”ìœ„: <strong>Â±5mm</strong>
            </p>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ì¸¡ì • ì •ë³´</h2>
            </div>
            <div class="card-body">
                <form id="errorInfoForm">
                    <div class="info-grid">
                        <div class="info-item">
                            <label class="info-label" for="errorDate">ì¸¡ì • ì¼ì‹œ</label>
                            <input type="datetime-local" id="errorDate" name="errorDate" class="info-value" required>
                        </div>
                        <div class="info-item">
                            <label class="info-label" for="errorDevice">ì¸¡ì • ì¥ë¹„</label>
                            <input type="text" id="errorDevice" name="errorDevice" class="info-value" 
                                   placeholder="ì˜ˆ: ë ˆì´ì € ê±°ë¦¬ ì¸¡ì •ê¸°" required>
                        </div>
                        <div class="info-item">
                            <label class="info-label" for="errorOperator">ì¸¡ì •ì</label>
                            <input type="text" id="errorOperator" name="errorOperator" class="info-value" 
                                   placeholder="ì¸¡ì •ìëª…" required>
                        </div>
                        <div class="info-item">
                            <label class="info-label" for="errorWeather">ì¸¡ì • í™˜ê²½</label>
                            <select id="errorWeather" name="errorWeather" class="info-value" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ì‹¤ë‚´">ì‹¤ë‚´</option>
                                <option value="ì‹¤ì™¸-ë§‘ìŒ">ì‹¤ì™¸ (ë§‘ìŒ)</option>
                                <option value="ì‹¤ì™¸-íë¦¼">ì‹¤ì™¸ (íë¦¼)</option>
                                <option value="ì‹¤ì™¸-ìš°ì²œ">ì‹¤ì™¸ (ìš°ì²œ)</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ë¶€ì¬ ì‚¬ì§„</h2>
                <p class="card-description">ì¸¡ì • ëŒ€ìƒ ë¶€ì¬ì˜ ì „ì²´ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
                    <div>
                        <h3 class="mb-2">ë¶€ì¬ ì „ë©´</h3>
                        <div class="photo-upload" style="min-height: 300px;">
                            <img id="errorPhoto1" style="display:none;">
                            <input type="file" accept="image/*" onchange="previewImage(this, 'errorPhoto1')">
                            <span class="placeholder">ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ</span>
                        </div>
                    </div>
                    <div>
                        <h3 class="mb-2">ë¶€ì¬ ì¸¡ë©´</h3>
                        <div class="photo-upload" style="min-height: 300px;">
                            <img id="errorPhoto2" style="display:none;">
                            <input type="file" accept="image/*" onchange="previewImage(this, 'errorPhoto2')">
                            <span class="placeholder">ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ì¹˜ìˆ˜ ì¸¡ì • ë°ì´í„°</h2>
                <p class="card-description">ê° í•­ëª©ì˜ ì„¤ê³„ì¹˜ì™€ ì¸¡ì •ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ë‹¨ìœ„: mm)</p>
            </div>
            <div class="card-body">
                <table>
                    <thead>
                        <tr>
                            <th>ì¸¡ì • í•­ëª©</th>
                            <th>ì„¤ê³„ì¹˜ (mm)</th>
                            <th>ì¸¡ì •ì¹˜ (mm)</th>
                            <th>ì˜¤ì°¨ (mm)</th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ì „ì²´ ê¸¸ì´</td>
                            <td><input type="number" step="0.1" name="design1" class="error-input" value="3000" onchange="calculateError(1)"></td>
                            <td><input type="number" step="0.1" name="measured1" class="error-input" onchange="calculateError(1)"></td>
                            <td id="error1">-</td>
                            <td id="errorStatus1">-</td>
                        </tr>
                        <tr>
                            <td>ì „ì²´ í­</td>
                            <td><input type="number" step="0.1" name="design2" class="error-input" value="300" onchange="calculateError(2)"></td>
                            <td><input type="number" step="0.1" name="measured2" class="error-input" onchange="calculateError(2)"></td>
                            <td id="error2">-</td>
                            <td id="errorStatus2">-</td>
                        </tr>
                        <tr>
                            <td>ì „ì²´ ë†’ì´</td>
                            <td><input type="number" step="0.1" name="design3" class="error-input" value="400" onchange="calculateError(3)"></td>
                            <td><input type="number" step="0.1" name="measured3" class="error-input" onchange="calculateError(3)"></td>
                            <td id="error3">-</td>
                            <td id="errorStatus3">-</td>
                        </tr>
                        <tr>
                            <td>ìƒë‹¨ ì¹˜ìˆ˜</td>
                            <td><input type="number" step="0.1" name="design4" class="error-input" value="250" onchange="calculateError(4)"></td>
                            <td><input type="number" step="0.1" name="measured4" class="error-input" onchange="calculateError(4)"></td>
                            <td id="error4">-</td>
                            <td id="errorStatus4">-</td>
                        </tr>
                        <tr>
                            <td>í•˜ë‹¨ ì¹˜ìˆ˜</td>
                            <td><input type="number" step="0.1" name="design5" class="error-input" value="250" onchange="calculateError(5)"></td>
                            <td><input type="number" step="0.1" name="measured5" class="error-input" onchange="calculateError(5)"></td>
                            <td id="error5">-</td>
                            <td id="errorStatus5">-</td>
                        </tr>
                        <tr>
                            <td>ëŒ€ê°ì„  ê¸¸ì´ 1</td>
                            <td><input type="number" step="0.1" name="design6" class="error-input" value="3020" onchange="calculateError(6)"></td>
                            <td><input type="number" step="0.1" name="measured6" class="error-input" onchange="calculateError(6)"></td>
                            <td id="error6">-</td>
                            <td id="errorStatus6">-</td>
                        </tr>
                        <tr>
                            <td>ëŒ€ê°ì„  ê¸¸ì´ 2</td>
                            <td><input type="number" step="0.1" name="design7" class="error-input" value="3020" onchange="calculateError(7)"></td>
                            <td><input type="number" step="0.1" name="measured7" class="error-input" onchange="calculateError(7)"></td>
                            <td id="error7">-</td>
                            <td id="errorStatus7">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ì œì‘ ì˜¤ì°¨ ë¶„í¬ ê·¸ë˜í”„</h2>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="errorChart"></canvas>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="updateErrorChart()">ğŸ“ˆ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ì¸¡ì • ê²°ê³¼ ìš”ì•½</h2>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ìµœëŒ€ ì˜¤ì°¨</div>
                        <div class="stat-value" id="maxError">0.0 mm</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">í‰ê·  ì˜¤ì°¨</div>
                        <div class="stat-value" id="avgError">0.0 mm</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì´ˆê³¼ í•­ëª©</div>
                        <div class="stat-value" id="errorExceedCount">0 ê°œ</div>
                    </div>
                    <div class="stat-card" id="errorFinalStatus">
                        <div class="stat-label">ì¢…í•© í‰ê°€</div>
                        <div class="stat-value">ëŒ€ê¸°ì¤‘</div>
                    </div>
                </div>
                <div id="errorResultAlert" class="mt-3"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ì¸¡ì • ìƒì„¸ ì‚¬ì§„</h2>
                <p class="card-description">ì£¼ìš” ì¸¡ì • ë¶€ìœ„ì˜ ìƒì„¸ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div>
                        <h3 class="mb-2">ì¸¡ì • ë¶€ìœ„ 1</h3>
                        <div class="photo-upload">
                            <img id="errorPhoto3" style="display:none;">
                            <input type="file" accept="image/*" onchange="previewImage(this, 'errorPhoto3')">
                            <span class="placeholder">ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ</span>
                        </div>
                    </div>
                    <div>
                        <h3 class="mb-2">ì¸¡ì • ë¶€ìœ„ 2</h3>
                        <div class="photo-upload">
                            <img id="errorPhoto4" style="display:none;">
                            <input type="file" accept="image/*" onchange="previewImage(this, 'errorPhoto4')">
                            <span class="placeholder">ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ</span>
                        </div>
                    </div>
                    <div>
                        <h3 class="mb-2">ì¸¡ì • ì¥ë¹„</h3>
                        <div class="photo-upload">
                            <img id="errorPhoto5" style="display:none;">
                            <input type="file" accept="image/*" onchange="previewImage(this, 'errorPhoto5')">
                            <span class="placeholder">ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ë¹„ê³  ë° íŠ¹ì´ì‚¬í•­</h2>
            </div>
            <div class="card-body">
                <textarea id="errorNotes" rows="5" 
                          placeholder="ì¸¡ì • ê³¼ì •ì—ì„œ ë°œê²¬ëœ íŠ¹ì´ì‚¬í•­ì´ë‚˜ ë¹„ê³ ì‚¬í•­ì„ ê¸°ë¡í•˜ì„¸ìš”..."
                          style="width: 100%; resize: vertical; padding: 1rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm);"></textarea>
            </div>
        </div>

        <div class="nav-buttons">
            <a href="page5.html" class="btn btn-secondary">â† ì´ì „: ë³€í˜•ë¥  ë°ì´í„°</a>
            <button class="btn btn-success" onclick="saveErrorData()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
            <a href="dashboard.html" class="btn btn-primary">ë‹¤ìŒ: ì¢…í•© ëŒ€ì‹œë³´ë“œ â†’</a>
        </div>
    </main>

    <script>
        const ERROR_THRESHOLD = 5.0; // mm

        document.addEventListener('DOMContentLoaded', function() {
            loadErrorData();
            
            for (let i = 1; i <= 5; i++) {
                loadSavedImage(`errorPhoto${i}`);
            }

            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('errorDate').value = now.toISOString().slice(0, 16);

            document.querySelectorAll('.error-input').forEach(input => {
                input.addEventListener('change', autoSaveErrorData);
            });
            
            document.getElementById('errorNotes').addEventListener('change', autoSaveErrorData);
            
            autoSaveForm('errorInfoForm', STORAGE_KEYS.FABRICATION_ERROR);
        });

        function calculateError(index) {
            const designInput = document.querySelector(`input[name="design${index}"]`);
            const measuredInput = document.querySelector(`input[name="measured${index}"]`);
            
            const design = parseFloat(designInput.value) || 0;
            const measured = parseFloat(measuredInput.value) || 0;
            const error = measured - design;
            
            document.getElementById(`error${index}`).textContent = error.toFixed(1) + ' mm';
            
            const statusCell = document.getElementById(`errorStatus${index}`);
            if (Math.abs(error) > ERROR_THRESHOLD) {
                statusCell.innerHTML = '<span class="badge badge-danger">ì´ˆê³¼</span>';
            } else if (measured > 0) {
                statusCell.innerHTML = '<span class="badge badge-success">ì •ìƒ</span>';
            } else {
                statusCell.textContent = '-';
            }
            
            updateErrorStatistics();
        }

        function updateErrorStatistics() {
            const errors = [];
            for (let i = 1; i <= 7; i++) {
                const errorText = document.getElementById(`error${i}`).textContent;
                if (errorText !== '-') {
                    errors.push(Math.abs(parseFloat(errorText)));
                }
            }
            
            if (errors.length === 0) return;
            
            const max = Math.max(...errors);
            const avg = errors.reduce((a, b) => a + b, 0) / errors.length;
            const exceedCount = errors.filter(e => e > ERROR_THRESHOLD).length;
            
            document.getElementById('maxError').textContent = max.toFixed(1) + ' mm';
            document.getElementById('avgError').textContent = avg.toFixed(1) + ' mm';
            document.getElementById('errorExceedCount').textContent = exceedCount + ' ê°œ';
            
            const finalStatus = document.getElementById('errorFinalStatus');
            const resultAlert = document.getElementById('errorResultAlert');
            
            if (exceedCount === 0) {
                finalStatus.className = 'stat-card success';
                finalStatus.querySelector('.stat-value').textContent = 'ì í•©';
                resultAlert.innerHTML = `
                    <div class="alert alert-success">
                        <strong>âœ… ì œì‘ ì˜¤ì°¨ ì í•©</strong><br>
                        ëª¨ë“  ì¸¡ì • í•­ëª©ì˜ ì˜¤ì°¨ê°€ í—ˆìš© ë²”ìœ„(Â±${ERROR_THRESHOLD}mm) ì´ë‚´ì…ë‹ˆë‹¤.
                    </div>
                `;
            } else {
                finalStatus.className = 'stat-card danger';
                finalStatus.querySelector('.stat-value').textContent = 'ë¶€ì í•©';
                resultAlert.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>âŒ ì œì‘ ì˜¤ì°¨ ë¶€ì í•©</strong><br>
                        ${exceedCount}ê°œ í•­ëª©ì˜ ì˜¤ì°¨ê°€ í—ˆìš© ë²”ìœ„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì¬ê°€ê³µ ë˜ëŠ” ë³´ê°•ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </div>
                `;
            }
        }

        function updateErrorChart() {
            const labels = ['ì „ì²´ ê¸¸ì´', 'ì „ì²´ í­', 'ì „ì²´ ë†’ì´', 'ìƒë‹¨', 'í•˜ë‹¨', 'ëŒ€ê°ì„ 1', 'ëŒ€ê°ì„ 2'];
            const values = [];
            const colors = [];
            
            for (let i = 1; i <= 7; i++) {
                const errorText = document.getElementById(`error${i}`).textContent;
                if (errorText !== '-') {
                    const value = Math.abs(parseFloat(errorText));
                    values.push(value);
                    colors.push(value > ERROR_THRESHOLD ? '#ef4444' : '#3b82f6');
                } else {
                    values.push(0);
                    colors.push('#9ca3af');
                }
            }
            
            drawBarChart('errorChart', {
                labels: labels,
                values: values,
                colors: colors,
                title: 'í•­ëª©ë³„ ì œì‘ ì˜¤ì°¨',
                yLabel: 'ì˜¤ì°¨ (mm)'
            });
        }

        function saveErrorData() {
            const data = {
                info: {},
                measurements: [],
                notes: document.getElementById('errorNotes').value
            };
            
            const infoForm = document.getElementById('errorInfoForm');
            const infoData = new FormData(infoForm);
            for (let [key, value] of infoData.entries()) {
                data.info[key] = value;
            }
            
            for (let i = 1; i <= 7; i++) {
                const design = parseFloat(document.querySelector(`input[name="design${i}"]`).value) || 0;
                const measured = parseFloat(document.querySelector(`input[name="measured${i}"]`).value) || 0;
                const errorText = document.getElementById(`error${i}`).textContent;
                const error = errorText !== '-' ? parseFloat(errorText) : 0;
                
                data.measurements.push({ design, measured, error });
            }
            
            saveToStorage(STORAGE_KEYS.FABRICATION_ERROR, data);
            alert('ì œì‘ ì˜¤ì°¨ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function autoSaveErrorData() {
            const data = {
                info: {},
                measurements: [],
                notes: document.getElementById('errorNotes').value
            };
            
            const infoForm = document.getElementById('errorInfoForm');
            const infoData = new FormData(infoForm);
            for (let [key, value] of infoData.entries()) {
                data.info[key] = value;
            }
            
            for (let i = 1; i <= 7; i++) {
                const design = parseFloat(document.querySelector(`input[name="design${i}"]`).value) || 0;
                const measured = parseFloat(document.querySelector(`input[name="measured${i}"]`).value) || 0;
                const errorText = document.getElementById(`error${i}`).textContent;
                const error = errorText !== '-' ? parseFloat(errorText) : 0;
                
                data.measurements.push({ design, measured, error });
            }
            
            saveToStorage(STORAGE_KEYS.FABRICATION_ERROR, data);
        }

        function loadErrorData() {
            const data = getFromStorage(STORAGE_KEYS.FABRICATION_ERROR);
            if (!data) return;
            
            if (data.info) {
                Object.keys(data.info).forEach(key => {
                    const input = document.getElementById(key);
                    if (input) input.value = data.info[key];
                });
            }
            
            if (data.measurements) {
                data.measurements.forEach((m, i) => {
                    const index = i + 1;
                    const designInput = document.querySelector(`input[name="design${index}"]`);
                    const measuredInput = document.querySelector(`input[name="measured${index}"]`);
                    
                    if (designInput) designInput.value = m.design;
                    if (measuredInput) measuredInput.value = m.measured;
                    
                    calculateError(index);
                });
                
                updateErrorChart();
            }
            
            if (data.notes) {
                document.getElementById('errorNotes').value = data.notes;
            }
        }
    </script>
</body>
</html>
