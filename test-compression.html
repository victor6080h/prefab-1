<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì••ì¶• í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        #preview {
            max-width: 100%;
            max-height: 400px;
            margin: 20px 0;
            display: none;
        }
        .log {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .info {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ì‚¬ì§„ ì••ì¶• í…ŒìŠ¤íŠ¸</h1>
    
    <div id="status"></div>
    
    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" accept="image/*" style="display: none;">
        <p>ğŸ“· í´ë¦­í•˜ì—¬ ì‚¬ì§„ ì—…ë¡œë“œ</p>
        <p style="font-size: 0.9em; color: #666;">ëŒ€ìš©ëŸ‰ ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš” (4-5MB ê¶Œì¥)</p>
    </div>
    
    <img id="preview" alt="ë¯¸ë¦¬ë³´ê¸°">
    
    <div id="info"></div>
    
    <h3>ğŸ“‹ ì••ì¶• ë¡œê·¸</h3>
    <div class="log" id="log"></div>
    
    <script>
        const logDiv = document.getElementById('log');
        const infoDiv = document.getElementById('info');
        const statusDiv = document.getElementById('status');
        const preview = document.getElementById('preview');
        
        // ì½˜ì†” ë¡œê·¸ ìº¡ì²˜
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addLog(message, type = 'log') {
            const time = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.style.color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
            line.textContent = `[${time}] ${message}`;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('ERROR: ' + args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('WARN: ' + args.join(' '), 'warn');
        };
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            console.log('=== íŒŒì¼ ì„ íƒë¨ ===');
            console.log('íŒŒì¼ëª…:', file.name);
            console.log('íŒŒì¼ í¬ê¸°:', (file.size / 1024).toFixed(0), 'KB');
            console.log('íŒŒì¼ íƒ€ì…:', file.type);
            
            statusDiv.innerHTML = '<div class="info warning">â³ ì••ì¶• ì§„í–‰ ì¤‘...</div>';
            infoDiv.innerHTML = '';
            
            // ì••ì¶• í•¨ìˆ˜ í˜¸ì¶œ
            resizeAndCompressImage(file, 110, null, 
                function(compressedDataUrl) {
                    // ì„±ê³µ
                    const compressedSize = compressedDataUrl.length / 1024;
                    preview.src = compressedDataUrl;
                    preview.style.display = 'block';
                    
                    statusDiv.innerHTML = '<div class="info success">âœ… ì••ì¶• ì„±ê³µ!</div>';
                    infoDiv.innerHTML = `
                        <div class="info success">
                            <strong>ì••ì¶• ì™„ë£Œ</strong><br>
                            ì›ë³¸ í¬ê¸°: ${(file.size / 1024).toFixed(0)} KB<br>
                            ì••ì¶• í›„ í¬ê¸°: ${compressedSize.toFixed(0)} KB<br>
                            ì••ì¶•ë¥ : ${((1 - compressedDataUrl.length / file.size) * 100).toFixed(1)}%
                        </div>
                    `;
                },
                function(error) {
                    // ì‹¤íŒ¨
                    statusDiv.innerHTML = '<div class="info error">âŒ ì••ì¶• ì‹¤íŒ¨!</div>';
                    infoDiv.innerHTML = `
                        <div class="info error">
                            <strong>ì˜¤ë¥˜ ë°œìƒ</strong><br>
                            ${error}
                        </div>
                    `;
                    console.error('ì••ì¶• ì‹¤íŒ¨:', error);
                }
            );
        });
        
        // ì••ì¶• í•¨ìˆ˜ (script.jsì—ì„œ ë³µì‚¬)
        function resizeAndCompressImage(file, targetSizeKB, quality, successCallback, errorCallback) {
            const TARGET_SIZE_KB = 110;
            const TARGET_SIZE_BYTES = TARGET_SIZE_KB * 1024;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                
                img.onload = function() {
                    try {
                        console.log('=== ìë™ ì••ì¶• ì‹œì‘ ===');
                        console.log('ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸°:', img.width, 'x', img.height);
                        console.log('ì›ë³¸ íŒŒì¼ í¬ê¸°:', (file.size / 1024).toFixed(0), 'KB');
                        console.log('ëª©í‘œ í¬ê¸°:', TARGET_SIZE_KB, 'KB');
                        
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        function tryCompress(width, height, quality) {
                            canvas.width = width;
                            canvas.height = height;
                            ctx.clearRect(0, 0, width, height);
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            const dataUrl = canvas.toDataURL('image/jpeg', quality);
                            const sizeKB = dataUrl.length / 1024;
                            
                            console.log(`ì‹œë„: ${width}x${height}, í’ˆì§ˆ: ${(quality * 100).toFixed(0)}% â†’ ${sizeKB.toFixed(0)}KB`);
                            
                            return {
                                dataUrl: dataUrl,
                                size: dataUrl.length,
                                sizeKB: sizeKB,
                                width: width,
                                height: height,
                                quality: quality
                            };
                        }
                        
                        let currentWidth = img.width;
                        let currentHeight = img.height;
                        let currentQuality = 0.85;
                        
                        const MAX_ATTEMPTS = 30;
                        let attempt = 0;
                        let bestResult = null;
                        
                        const MIN_PIXELS = 200 * 200;
                        
                        while (attempt < MAX_ATTEMPTS) {
                            attempt++;
                            
                            const result = tryCompress(currentWidth, currentHeight, currentQuality);
                            
                            if (result.size <= TARGET_SIZE_BYTES) {
                                bestResult = result;
                                console.log(`âœ… ëª©í‘œ ë‹¬ì„±! ${attempt}ë²ˆ ì‹œë„`);
                                break;
                            }
                            
                            if (!bestResult || Math.abs(result.size - TARGET_SIZE_BYTES) < Math.abs(bestResult.size - TARGET_SIZE_BYTES)) {
                                bestResult = result;
                            }
                            
                            const ratio = result.size / TARGET_SIZE_BYTES;
                            const currentPixels = currentWidth * currentHeight;
                            
                            if (currentPixels > MIN_PIXELS) {
                                if (ratio > 2.5) {
                                    currentWidth = Math.floor(currentWidth * 0.65);
                                    currentHeight = Math.floor(currentHeight * 0.65);
                                } else if (ratio > 2.0) {
                                    currentWidth = Math.floor(currentWidth * 0.75);
                                    currentHeight = Math.floor(currentHeight * 0.75);
                                } else if (ratio > 1.5) {
                                    currentWidth = Math.floor(currentWidth * 0.85);
                                    currentHeight = Math.floor(currentHeight * 0.85);
                                } else if (ratio > 1.2) {
                                    currentWidth = Math.floor(currentWidth * 0.92);
                                    currentHeight = Math.floor(currentHeight * 0.92);
                                } else {
                                    currentQuality = Math.max(0.3, currentQuality - 0.05);
                                }
                            } else {
                                console.log('âš ï¸ ìµœì†Œ í•´ìƒë„ ë„ë‹¬, í’ˆì§ˆ ìš°ì„  ì••ì¶•');
                                currentQuality = Math.max(0.2, currentQuality - 0.05);
                                
                                if (currentQuality <= 0.2) {
                                    console.log('âš ï¸ ìµœì†Œ í’ˆì§ˆ ë„ë‹¬, ì••ì¶• ì¤‘ë‹¨');
                                    break;
                                }
                            }
                        }
                        
                        if (!bestResult) {
                            throw new Error('ì••ì¶• ì‹¤íŒ¨');
                        }
                        
                        const originalSizeKB = file.size / 1024;
                        const finalSizeKB = bestResult.sizeKB;
                        const compressionRatio = ((1 - bestResult.size / file.size) * 100).toFixed(1);
                        
                        console.log('=== ì••ì¶• ì™„ë£Œ ===');
                        console.log(`ì›ë³¸: ${originalSizeKB.toFixed(0)}KB (${img.width}x${img.height})`);
                        console.log(`ê²°ê³¼: ${finalSizeKB.toFixed(0)}KB (${bestResult.width}x${bestResult.height})`);
                        console.log(`í’ˆì§ˆ: ${(bestResult.quality * 100).toFixed(0)}%`);
                        console.log(`ì••ì¶•ë¥ : ${compressionRatio}%`);
                        console.log(`ì‹œë„ íšŸìˆ˜: ${attempt}íšŒ`);
                        
                        if (bestResult.sizeKB > TARGET_SIZE_KB) {
                            console.warn(`âš ï¸ ëª©í‘œ í¬ê¸°(${TARGET_SIZE_KB}KB) ë¯¸ë‹¬ì„±, ìµœì„ ì˜ ê²°ê³¼: ${finalSizeKB.toFixed(0)}KB`);
                        } else {
                            console.log(`âœ… ëª©í‘œ í¬ê¸° ë‹¬ì„±! (${TARGET_SIZE_KB}KB ì´í•˜)`);
                        }
                        
                        successCallback(bestResult.dataUrl);
                        
                    } catch (error) {
                        console.error('ì´ë¯¸ì§€ ì••ì¶• ì˜¤ë¥˜:', error);
                        errorCallback(error);
                    }
                };
                
                img.onerror = function(error) {
                    console.error('ì´ë¯¸ì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
                    errorCallback(error);
                };
                
                img.src = e.target.result;
            };
            
            reader.onerror = function(error) {
                console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
                errorCallback(error);
            };
            
            reader.readAsDataURL(file);
        }
        
        console.log('ğŸš€ ì••ì¶• í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì¤€ë¹„ ì™„ë£Œ');
        console.log('ëŒ€ìš©ëŸ‰ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì—¬ ì••ì¶•ì„ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”');
    </script>
</body>
</html>
