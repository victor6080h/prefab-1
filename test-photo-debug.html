<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ì§„ ì—…ë¡œë“œ ë””ë²„ê¹… í…ŒìŠ¤íŠ¸</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 9999;
        }
        
        .debug-panel h3 {
            margin: 0 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #333;
        }
        
        .log-entry {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: monospace;
        }
        
        .log-success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
        }
        
        .log-error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
        }
        
        .log-info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
        }
        
        .log-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        
        .storage-info {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        
        .storage-info h4 {
            margin: 0 0 0.5rem 0;
        }
        
        .photo-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            font-size: 0.8rem;
        }
    </style>
    <script src="assets/js/script.js"></script>
</head>
<body>
    <!-- ë””ë²„ê·¸ íŒ¨ë„ -->
    <div class="debug-panel">
        <h3>ğŸ” ì‹¤ì‹œê°„ ë””ë²„ê¹…</h3>
        <button onclick="clearLogs()" style="width: 100%; margin-bottom: 1rem;" class="btn btn-secondary">ë¡œê·¸ ì§€ìš°ê¸°</button>
        <div id="debugLogs"></div>
        <div class="storage-info">
            <h4>ğŸ“Š LocalStorage ìƒíƒœ</h4>
            <div>ì‚¬ìš©ëŸ‰: <span id="storageUsage">0</span> / <span id="storageLimit">5120</span> KB</div>
            <div style="margin-top: 0.5rem;">
                <strong>ì €ì¥ëœ ì‚¬ì§„:</strong>
                <div id="photoList"></div>
            </div>
        </div>
    </div>

    <div class="container" style="margin-top: 2rem;">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ì‚¬ì§„ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸ (6ì¥)</h2>
                <p class="card-description">ê° ì‚¬ì§„ì„ ìˆœì°¨ì ìœ¼ë¡œ ì—…ë¡œë“œí•˜ê³  ì €ì¥ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                    <!-- ì‚¬ì§„ 1 -->
                    <label for="fileInput1" class="photo-upload" style="margin: 0;">
                        <input type="file" id="fileInput1" accept="image/*" onchange="testPhotoUpload(this, 'photo1Preview', 1)" style="display: none;">
                        <img id="photo1Preview" style="display:none;">
                        <span class="placeholder">ğŸ“· ì‚¬ì§„ 1 (í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ)</span>
                    </label>

                    <!-- ì‚¬ì§„ 2 -->
                    <label for="fileInput2" class="photo-upload" style="margin: 0;">
                        <input type="file" id="fileInput2" accept="image/*" onchange="testPhotoUpload(this, 'photo2Preview', 2)" style="display: none;">
                        <img id="photo2Preview" style="display:none;">
                        <span class="placeholder">ğŸ“· ì‚¬ì§„ 2 (í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ)</span>
                    </label>

                    <!-- ì‚¬ì§„ 3 -->
                    <label for="fileInput3" class="photo-upload" style="margin: 0;">
                        <input type="file" id="fileInput3" accept="image/*" onchange="testPhotoUpload(this, 'photo3Preview', 3)" style="display: none;">
                        <img id="photo3Preview" style="display:none;">
                        <span class="placeholder">ğŸ“· ì‚¬ì§„ 3 (í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ)</span>
                    </label>

                    <!-- ì‚¬ì§„ 4 -->
                    <label for="fileInput4" class="photo-upload" style="margin: 0;">
                        <input type="file" id="fileInput4" accept="image/*" onchange="testPhotoUpload(this, 'photo4Preview', 4)" style="display: none;">
                        <img id="photo4Preview" style="display:none;">
                        <span class="placeholder">ğŸ“· ì‚¬ì§„ 4 (í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ)</span>
                    </label>

                    <!-- ì‚¬ì§„ 5 -->
                    <label for="fileInput5" class="photo-upload" style="margin: 0;">
                        <input type="file" id="fileInput5" accept="image/*" onchange="testPhotoUpload(this, 'photo5Preview', 5)" style="display: none;">
                        <img id="photo5Preview" style="display:none;">
                        <span class="placeholder">ğŸ“· ì‚¬ì§„ 5 (í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ)</span>
                    </label>

                    <!-- ì‚¬ì§„ 6 -->
                    <label for="fileInput6" class="photo-upload" style="margin: 0;">
                        <input type="file" id="fileInput6" accept="image/*" onchange="testPhotoUpload(this, 'photo6Preview', 6)" style="display: none;">
                        <img id="photo6Preview" style="display:none;">
                        <span class="placeholder">ğŸ“· ì‚¬ì§„ 6 (í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ)</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 2rem;">
            <div class="card-header">
                <h2 class="card-title">í…ŒìŠ¤íŠ¸ ë„êµ¬</h2>
            </div>
            <div class="card-body">
                <button onclick="checkAllPhotos()" class="btn btn-primary" style="margin-right: 1rem;">ğŸ“Š ì „ì²´ ì‚¬ì§„ ìƒíƒœ í™•ì¸</button>
                <button onclick="clearAllPhotos()" class="btn btn-danger" style="margin-right: 1rem;">ğŸ—‘ï¸ ëª¨ë“  ì‚¬ì§„ ì‚­ì œ</button>
                <button onclick="checkLocalStorageSize()" class="btn btn-info">ğŸ’¾ LocalStorage í¬ê¸° í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        let uploadAttempts = 0;
        let successfulUploads = 0;
        let failedUploads = 0;

        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('debugLogs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.insertBefore(logEntry, logsDiv.firstChild);
            
            // ìµœëŒ€ 50ê°œ ë¡œê·¸ë§Œ ìœ ì§€
            if (logsDiv.children.length > 50) {
                logsDiv.removeChild(logsDiv.lastChild);
            }
        }

        function clearLogs() {
            document.getElementById('debugLogs').innerHTML = '';
            addLog('ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.', 'info');
        }

        function updateStorageInfo() {
            try {
                const photos = getFromStorage(STORAGE_KEYS.PHOTOS) || {};
                const photoKeys = Object.keys(photos);
                
                // ì´ ì‚¬ìš©ëŸ‰ ê³„ì‚°
                let totalSize = 0;
                let allData = '';
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        allData += localStorage[key];
                    }
                }
                totalSize = new Blob([allData]).size / 1024; // KB
                
                document.getElementById('storageUsage').textContent = totalSize.toFixed(2);
                
                // ì‚¬ì§„ ëª©ë¡ í‘œì‹œ
                const photoList = document.getElementById('photoList');
                photoList.innerHTML = '';
                
                for (let i = 1; i <= 6; i++) {
                    const key = `photo${i}Preview`;
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    
                    if (photos[key]) {
                        const size = (photos[key].length / 1024).toFixed(2);
                        photoItem.innerHTML = `<span>âœ… ì‚¬ì§„ ${i}</span><span>${size} KB</span>`;
                        photoItem.style.color = '#10b981';
                    } else {
                        photoItem.innerHTML = `<span>âŒ ì‚¬ì§„ ${i}</span><span>ì—†ìŒ</span>`;
                        photoItem.style.color = '#6b7280';
                    }
                    
                    photoList.appendChild(photoItem);
                }
            } catch (error) {
                addLog(`Storage ì •ë³´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        function testPhotoUpload(input, previewId, photoNumber) {
            uploadAttempts++;
            addLog(`[ì‚¬ì§„ ${photoNumber}] ì—…ë¡œë“œ ì‹œë„ #${uploadAttempts}`, 'info');
            
            if (!input || !input.files || !input.files[0]) {
                addLog(`[ì‚¬ì§„ ${photoNumber}] íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•ŠìŒ`, 'error');
                failedUploads++;
                return;
            }
            
            const file = input.files[0];
            const fileSizeKB = (file.size / 1024).toFixed(2);
            const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
            
            addLog(`[ì‚¬ì§„ ${photoNumber}] íŒŒì¼ëª…: ${file.name}`, 'info');
            addLog(`[ì‚¬ì§„ ${photoNumber}] íŒŒì¼ í¬ê¸°: ${fileSizeKB} KB (${fileSizeMB} MB)`, 'info');
            addLog(`[ì‚¬ì§„ ${photoNumber}] íŒŒì¼ íƒ€ì…: ${file.type}`, 'info');
            
            // í¬ê¸° ì²´í¬
            if (file.size > 5 * 1024 * 1024) {
                addLog(`[ì‚¬ì§„ ${photoNumber}] âŒ íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤! (5MB ì œí•œ)`, 'error');
                alert(`ì‚¬ì§„ ${photoNumber}: íŒŒì¼ í¬ê¸°ê°€ ${fileSizeMB}MBì…ë‹ˆë‹¤.\n5MB ì´í•˜ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                input.value = '';
                failedUploads++;
                return;
            }
            
            // íƒ€ì… ì²´í¬
            if (!file.type.startsWith('image/')) {
                addLog(`[ì‚¬ì§„ ${photoNumber}] âŒ ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤!`, 'error');
                alert(`ì‚¬ì§„ ${photoNumber}: ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                input.value = '';
                failedUploads++;
                return;
            }
            
            const preview = document.getElementById(previewId);
            if (!preview) {
                addLog(`[ì‚¬ì§„ ${photoNumber}] âŒ ë¯¸ë¦¬ë³´ê¸° ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${previewId}`, 'error');
                failedUploads++;
                return;
            }
            
            const container = preview.closest('.photo-upload');
            const placeholder = container ? container.querySelector('.placeholder') : null;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const imageData = e.target.result;
                    const imageSizeKB = (imageData.length / 1024).toFixed(2);
                    
                    addLog(`[ì‚¬ì§„ ${photoNumber}] ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ: ${imageSizeKB} KB`, 'success');
                    
                    // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                    preview.src = imageData;
                    preview.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                    if (container) container.classList.add('has-image');
                    
                    addLog(`[ì‚¬ì§„ ${photoNumber}] ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ ì™„ë£Œ`, 'success');
                    
                    // LocalStorage ì €ì¥ ì „ ìƒíƒœ í™•ì¸
                    const beforePhotos = getFromStorage(STORAGE_KEYS.PHOTOS) || {};
                    const beforeCount = Object.keys(beforePhotos).length;
                    addLog(`[ì‚¬ì§„ ${photoNumber}] ì €ì¥ ì „ ì‚¬ì§„ ê°œìˆ˜: ${beforeCount}ê°œ`, 'info');
                    
                    // LocalStorageì— ì €ì¥
                    try {
                        beforePhotos[previewId] = imageData;
                        const saveResult = saveToStorage(STORAGE_KEYS.PHOTOS, beforePhotos);
                        
                        if (saveResult === false) {
                            throw new Error('saveToStorage ì‹¤íŒ¨');
                        }
                        
                        // ì €ì¥ í›„ í™•ì¸
                        const afterPhotos = getFromStorage(STORAGE_KEYS.PHOTOS) || {};
                        const afterCount = Object.keys(afterPhotos).length;
                        
                        if (afterPhotos[previewId]) {
                            addLog(`[ì‚¬ì§„ ${photoNumber}] âœ… LocalStorage ì €ì¥ ì„±ê³µ!`, 'success');
                            addLog(`[ì‚¬ì§„ ${photoNumber}] ì €ì¥ í›„ ì‚¬ì§„ ê°œìˆ˜: ${afterCount}ê°œ`, 'success');
                            successfulUploads++;
                        } else {
                            throw new Error('ì €ì¥ í›„ í™•ì¸ ì‹¤íŒ¨');
                        }
                        
                    } catch (storageError) {
                        addLog(`[ì‚¬ì§„ ${photoNumber}] âŒ LocalStorage ì €ì¥ ì‹¤íŒ¨: ${storageError.message}`, 'error');
                        
                        // LocalStorage quota ì´ˆê³¼ í™•ì¸
                        if (storageError.name === 'QuotaExceededError') {
                            addLog(`[ì‚¬ì§„ ${photoNumber}] âŒ LocalStorage ìš©ëŸ‰ ì´ˆê³¼!`, 'error');
                            alert(`ì‚¬ì§„ ${photoNumber}: LocalStorage ìš©ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\nì¼ë¶€ ì‚¬ì§„ì„ ì‚­ì œí•˜ê±°ë‚˜ ì‘ì€ í¬ê¸°ì˜ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.`);
                        }
                        failedUploads++;
                    }
                    
                    updateStorageInfo();
                    
                } catch (error) {
                    addLog(`[ì‚¬ì§„ ${photoNumber}] âŒ ì²˜ë¦¬ ì˜¤ë¥˜: ${error.message}`, 'error');
                    console.error('ìƒì„¸ ì˜¤ë¥˜:', error);
                    failedUploads++;
                }
            };
            
            reader.onerror = function(error) {
                addLog(`[ì‚¬ì§„ ${photoNumber}] âŒ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: ${error}`, 'error');
                failedUploads++;
            };
            
            reader.readAsDataURL(file);
        }

        function checkAllPhotos() {
            addLog('=== ì „ì²´ ì‚¬ì§„ ìƒíƒœ í™•ì¸ ì‹œì‘ ===', 'info');
            
            const photos = getFromStorage(STORAGE_KEYS.PHOTOS) || {};
            const photoKeys = Object.keys(photos);
            
            addLog(`ì´ ì €ì¥ëœ í•­ëª©: ${photoKeys.length}ê°œ`, 'info');
            
            let message = `ğŸ“Š ì—…ë¡œë“œ í†µê³„:\n`;
            message += `ì´ ì‹œë„: ${uploadAttempts}íšŒ\n`;
            message += `ì„±ê³µ: ${successfulUploads}íšŒ\n`;
            message += `ì‹¤íŒ¨: ${failedUploads}íšŒ\n\n`;
            message += `--- ì €ì¥ëœ ì‚¬ì§„ ---\n`;
            
            for (let i = 1; i <= 6; i++) {
                const key = `photo${i}Preview`;
                if (photos[key]) {
                    const size = (photos[key].length / 1024).toFixed(2);
                    message += `âœ… ì‚¬ì§„ ${i}: ${size} KB\n`;
                    addLog(`ì‚¬ì§„ ${i}: ì €ì¥ë¨ (${size} KB)`, 'success');
                } else {
                    message += `âŒ ì‚¬ì§„ ${i}: ì—†ìŒ\n`;
                    addLog(`ì‚¬ì§„ ${i}: ì—†ìŒ`, 'warning');
                }
            }
            
            alert(message);
            updateStorageInfo();
        }

        function clearAllPhotos() {
            if (confirm('ëª¨ë“  ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('qms_photos');
                addLog('ëª¨ë“  ì‚¬ì§„ ì‚­ì œë¨', 'warning');
                
                // ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
                for (let i = 1; i <= 6; i++) {
                    const preview = document.getElementById(`photo${i}Preview`);
                    if (preview) {
                        preview.src = '';
                        preview.style.display = 'none';
                        const container = preview.closest('.photo-upload');
                        if (container) {
                            container.classList.remove('has-image');
                            const placeholder = container.querySelector('.placeholder');
                            if (placeholder) placeholder.style.display = 'block';
                        }
                    }
                }
                
                uploadAttempts = 0;
                successfulUploads = 0;
                failedUploads = 0;
                
                updateStorageInfo();
            }
        }

        function checkLocalStorageSize() {
            let totalSize = 0;
            let details = '=== LocalStorage ìƒì„¸ ì •ë³´ ===\n\n';
            
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    const itemSize = localStorage[key].length;
                    totalSize += itemSize;
                    details += `${key}: ${(itemSize / 1024).toFixed(2)} KB\n`;
                }
            }
            
            details += `\nì´ ì‚¬ìš©ëŸ‰: ${(totalSize / 1024).toFixed(2)} KB`;
            details += `\në‚¨ì€ ìš©ëŸ‰: ì•½ ${(5120 - (totalSize / 1024)).toFixed(2)} KB`;
            
            addLog(`LocalStorage ì´ ì‚¬ìš©ëŸ‰: ${(totalSize / 1024).toFixed(2)} KB`, 'info');
            alert(details);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ Storage ì •ë³´ ì—…ë°ì´íŠ¸
        document.addEventListener('DOMContentLoaded', function() {
            addLog('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'success');
            updateStorageInfo();
            
            // ì €ì¥ëœ ì´ë¯¸ì§€ ë¡œë“œ
            setTimeout(function() {
                for (let i = 1; i <= 6; i++) {
                    loadSavedImage(`photo${i}Preview`);
                }
                updateStorageInfo();
            }, 100);
        });
    </script>
</body>
</html>
