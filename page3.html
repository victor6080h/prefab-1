<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í’ˆì§ˆê´€ë¦¬ ì‹œìŠ¤í…œ - ê°€ì†ë„ ë°ì´í„°</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <script defer src="assets/js/script.js"></script>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <div class="container">
            <h1 class="header-title">Prefab í’ˆì§ˆê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <p class="header-subtitle">ê°€ì†ë„ ë°ì´í„° ì¸¡ì • ë° ë¶„ì„</p>
        </div>
    </header>

    <!-- í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="page-nav">
        <div class="container">
            <ul>
                <li><a href="index.html">1. ì¢…í•© ìš”ì•½</a></li>
                <li><a href="page2.html">2. í’ˆì§ˆê´€ë¦¬ì ì„¤ë¬¸</a></li>
                <li><a href="page3.html" class="active">3. ê°€ì†ë„ ë°ì´í„°</a></li>
                <li><a href="page4.html">4. ê¸°ìš¸ê¸° ë°ì´í„°</a></li>
                <li><a href="page5.html">5. ë³€í˜•ë¥  ë°ì´í„°</a></li>
                <li><a href="page6.html">6. ë¶€ì¬ ì œì‘ ì˜¤ì°¨</a></li>
                <li><a href="dashboard.html">7. ì¢…í•© ëŒ€ì‹œë³´ë“œ</a></li>
            </ul>
        </div>
    </nav>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="container">
        <!-- ì•ˆë‚´ ì‚¬í•­ -->
        <div class="alert alert-info">
            <strong>ğŸ“Š ê°€ì†ë„ ê³„ì¸¡ ì•ˆë‚´</strong>
            <p style="margin-top: 0.5rem;">
                Prefab ë¶€ì¬ì˜ ìš´ë°˜ ë° ì„¤ì¹˜ ê³¼ì •ì—ì„œ ë°œìƒí•˜ëŠ” ê°€ì†ë„ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤. 
                í—ˆìš© ë²”ìœ„: <strong>Â±0.5g</strong> (1g = 9.8 m/sÂ²)
            </p>
        </div>

        <!-- ê³„ì¸¡ ì •ë³´ ì…ë ¥ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ê³„ì¸¡ ì •ë³´</h2>
            </div>
            <div class="card-body">
                <form id="accelInfoForm">
                    <div class="info-grid">
                        <div class="info-item">
                            <label class="info-label" for="accelDate">ì¸¡ì • ì¼ì‹œ</label>
                            <input type="datetime-local" id="accelDate" name="accelDate" class="info-value" required>
                        </div>
                        <div class="info-item">
                            <label class="info-label" for="accelLocation">ì¸¡ì • ìœ„ì¹˜</label>
                            <select id="accelLocation" name="accelLocation" class="info-value" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ì œì‘ì¥">ì œì‘ì¥</option>
                                <option value="ìš´ë°˜ì¤‘">ìš´ë°˜ì¤‘</option>
                                <option value="ì–‘ì¤‘">ì–‘ì¤‘</option>
                                <option value="ì„¤ì¹˜">ì„¤ì¹˜</option>
                            </select>
                        </div>
                        <div class="info-item">
                            <label class="info-label" for="accelDevice">ì¸¡ì • ì¥ë¹„</label>
                            <input type="text" id="accelDevice" name="accelDevice" class="info-value" 
                                   placeholder="ì˜ˆ: ABC-100" required>
                        </div>
                        <div class="info-item">
                            <label class="info-label" for="accelOperator">ì¸¡ì •ì</label>
                            <input type="text" id="accelOperator" name="accelOperator" class="info-value" 
                                   placeholder="ì¸¡ì •ìëª…" required>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- ê°€ì†ë„ ë°ì´í„° ì…ë ¥ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ê°€ì†ë„ ì¸¡ì • ë°ì´í„°</h2>
                <p class="card-description">X, Y, Z ì¶•ë³„ ê°€ì†ë„ ê°’ì„ ì…ë ¥í•˜ì„¸ìš” (ë‹¨ìœ„: g)</p>
            </div>
            <div class="card-body">
                <table>
                    <thead>
                        <tr>
                            <th>ì¸¡ì • ì‹œì </th>
                            <th>Xì¶• (g)</th>
                            <th>Yì¶• (g)</th>
                            <th>Zì¶• (g)</th>
                            <th>í•©ì„± (g)</th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody id="accelDataTable">
                        <tr>
                            <td>ì¸¡ì • 1</td>
                            <td><input type="number" step="0.01" name="x1" class="accel-input" onchange="calculateResultant(1)"></td>
                            <td><input type="number" step="0.01" name="y1" class="accel-input" onchange="calculateResultant(1)"></td>
                            <td><input type="number" step="0.01" name="z1" class="accel-input" onchange="calculateResultant(1)"></td>
                            <td id="result1">-</td>
                            <td id="status1">-</td>
                        </tr>
                        <tr>
                            <td>ì¸¡ì • 2</td>
                            <td><input type="number" step="0.01" name="x2" class="accel-input" onchange="calculateResultant(2)"></td>
                            <td><input type="number" step="0.01" name="y2" class="accel-input" onchange="calculateResultant(2)"></td>
                            <td><input type="number" step="0.01" name="z2" class="accel-input" onchange="calculateResultant(2)"></td>
                            <td id="result2">-</td>
                            <td id="status2">-</td>
                        </tr>
                        <tr>
                            <td>ì¸¡ì • 3</td>
                            <td><input type="number" step="0.01" name="x3" class="accel-input" onchange="calculateResultant(3)"></td>
                            <td><input type="number" step="0.01" name="y3" class="accel-input" onchange="calculateResultant(3)"></td>
                            <td><input type="number" step="0.01" name="z3" class="accel-input" onchange="calculateResultant(3)"></td>
                            <td id="result3">-</td>
                            <td id="status3">-</td>
                        </tr>
                        <tr>
                            <td>ì¸¡ì • 4</td>
                            <td><input type="number" step="0.01" name="x4" class="accel-input" onchange="calculateResultant(4)"></td>
                            <td><input type="number" step="0.01" name="y4" class="accel-input" onchange="calculateResultant(4)"></td>
                            <td><input type="number" step="0.01" name="z4" class="accel-input" onchange="calculateResultant(4)"></td>
                            <td id="result4">-</td>
                            <td id="status4">-</td>
                        </tr>
                        <tr>
                            <td>ì¸¡ì • 5</td>
                            <td><input type="number" step="0.01" name="x5" class="accel-input" onchange="calculateResultant(5)"></td>
                            <td><input type="number" step="0.01" name="y5" class="accel-input" onchange="calculateResultant(5)"></td>
                            <td><input type="number" step="0.01" name="z5" class="accel-input" onchange="calculateResultant(5)"></td>
                            <td id="result5">-</td>
                            <td id="status5">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ê°€ì†ë„ ê·¸ë˜í”„ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ê°€ì†ë„ ì¶”ì´ ê·¸ë˜í”„</h2>
                <p class="card-description">ì¸¡ì •ëœ í•©ì„± ê°€ì†ë„ì˜ ë³€í™”ë¥¼ ì‹œê°í™”í•©ë‹ˆë‹¤</p>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="accelChart"></canvas>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="updateChart()">ğŸ“ˆ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸</button>
                </div>
            </div>
        </div>

        <!-- ì¸¡ì • ê²°ê³¼ ìš”ì•½ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ì¸¡ì • ê²°ê³¼ ìš”ì•½</h2>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ìµœëŒ€ ê°€ì†ë„</div>
                        <div class="stat-value" id="maxAccel">0.00 g</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">í‰ê·  ê°€ì†ë„</div>
                        <div class="stat-value" id="avgAccel">0.00 g</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì´ˆê³¼ íšŸìˆ˜</div>
                        <div class="stat-value" id="exceedCount">0 íšŒ</div>
                    </div>
                    <div class="stat-card" id="finalStatus">
                        <div class="stat-label">ì¢…í•© í‰ê°€</div>
                        <div class="stat-value">ëŒ€ê¸°ì¤‘</div>
                    </div>
                </div>

                <div id="resultAlert" class="mt-3"></div>
            </div>
        </div>

        <!-- ì¸¡ì • ì‚¬ì§„ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ì¸¡ì • í˜„ì¥ ì‚¬ì§„</h2>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div>
                        <h3 class="mb-2">ì¸¡ì • ì¥ë¹„ ì„¤ì¹˜</h3>
                        <div class="photo-upload">
                            <img id="accelPhoto1" style="display:none;">
                            <input type="file" accept="image/*" onchange="previewImage(this, 'accelPhoto1')">
                            <span class="placeholder">ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ</span>
                        </div>
                    </div>
                    <div>
                        <h3 class="mb-2">ì¸¡ì • ì¤‘ í˜„ì¥</h3>
                        <div class="photo-upload">
                            <img id="accelPhoto2" style="display:none;">
                            <input type="file" accept="image/*" onchange="previewImage(this, 'accelPhoto2')">
                            <span class="placeholder">ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
        <div class="nav-buttons">
            <a href="page2.html" class="btn btn-secondary">â† ì´ì „: í’ˆì§ˆê´€ë¦¬ì ì„¤ë¬¸</a>
            <button class="btn btn-success" onclick="saveAccelData()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
            <a href="page4.html" class="btn btn-primary">ë‹¤ìŒ: ê¸°ìš¸ê¸° ë°ì´í„° â†’</a>
        </div>
    </main>

    <script>
        // ê°€ì†ë„ ì„ê³„ê°’ (g)
        const ACCEL_THRESHOLD = 0.5;

        document.addEventListener('DOMContentLoaded', function() {
            // ì €ì¥ëœ ë°ì´í„° ë¡œë“œ
            loadAccelData();
            
            // ì €ì¥ëœ ì´ë¯¸ì§€ ë¡œë“œ
            loadSavedImage('accelPhoto1');
            loadSavedImage('accelPhoto2');

            // í˜„ì¬ ë‚ ì§œ/ì‹œê°„ ì„¤ì •
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('accelDate').value = now.toISOString().slice(0, 16);

            // ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ìë™ ì €ì¥
            document.querySelectorAll('.accel-input').forEach(input => {
                input.addEventListener('change', autoSaveAccelData);
            });
            
            autoSaveForm('accelInfoForm', STORAGE_KEYS.ACCELERATION_DATA);
        });

        // í•©ì„± ê°€ì†ë„ ê³„ì‚°
        function calculateResultant(index) {
            const xInput = document.querySelector(`input[name="x${index}"]`);
            const yInput = document.querySelector(`input[name="y${index}"]`);
            const zInput = document.querySelector(`input[name="z${index}"]`);
            
            const x = parseFloat(xInput.value) || 0;
            const y = parseFloat(yInput.value) || 0;
            const z = parseFloat(zInput.value) || 0;
            
            const resultant = Math.sqrt(x*x + y*y + z*z);
            
            document.getElementById(`result${index}`).textContent = resultant.toFixed(3) + ' g';
            
            // ìƒíƒœ í‘œì‹œ
            const statusCell = document.getElementById(`status${index}`);
            if (resultant > ACCEL_THRESHOLD) {
                statusCell.innerHTML = '<span class="badge badge-danger">ì´ˆê³¼</span>';
            } else if (resultant > 0) {
                statusCell.innerHTML = '<span class="badge badge-success">ì •ìƒ</span>';
            } else {
                statusCell.textContent = '-';
            }
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            updateStatistics();
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            const results = [];
            for (let i = 1; i <= 5; i++) {
                const resultText = document.getElementById(`result${i}`).textContent;
                if (resultText !== '-') {
                    results.push(parseFloat(resultText));
                }
            }
            
            if (results.length === 0) return;
            
            const max = Math.max(...results);
            const avg = results.reduce((a, b) => a + b, 0) / results.length;
            const exceedCount = results.filter(r => r > ACCEL_THRESHOLD).length;
            
            document.getElementById('maxAccel').textContent = max.toFixed(3) + ' g';
            document.getElementById('avgAccel').textContent = avg.toFixed(3) + ' g';
            document.getElementById('exceedCount').textContent = exceedCount + ' íšŒ';
            
            // ì¢…í•© í‰ê°€
            const finalStatus = document.getElementById('finalStatus');
            const resultAlert = document.getElementById('resultAlert');
            
            if (exceedCount === 0) {
                finalStatus.className = 'stat-card success';
                finalStatus.querySelector('.stat-value').textContent = 'ì í•©';
                resultAlert.innerHTML = `
                    <div class="alert alert-success">
                        <strong>âœ… ì¸¡ì • ê²°ê³¼ ì í•©</strong><br>
                        ëª¨ë“  ì¸¡ì •ê°’ì´ í—ˆìš© ë²”ìœ„(Â±${ACCEL_THRESHOLD}g) ì´ë‚´ì…ë‹ˆë‹¤.
                    </div>
                `;
            } else {
                finalStatus.className = 'stat-card danger';
                finalStatus.querySelector('.stat-value').textContent = 'ë¶€ì í•©';
                resultAlert.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>âŒ ì¸¡ì • ê²°ê³¼ ë¶€ì í•©</strong><br>
                        ${exceedCount}ê°œ ì¸¡ì •ê°’ì´ í—ˆìš© ë²”ìœ„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </div>
                `;
            }
        }

        // ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
        function updateChart() {
            const labels = ['ì¸¡ì • 1', 'ì¸¡ì • 2', 'ì¸¡ì • 3', 'ì¸¡ì • 4', 'ì¸¡ì • 5'];
            const values = [];
            
            for (let i = 1; i <= 5; i++) {
                const resultText = document.getElementById(`result${i}`).textContent;
                if (resultText !== '-') {
                    values.push(parseFloat(resultText));
                } else {
                    values.push(0);
                }
            }
            
            const chartData = {
                labels: labels,
                values: values,
                thresholds: {
                    upper: ACCEL_THRESHOLD,
                    lower: -ACCEL_THRESHOLD
                },
                title: 'ê°€ì†ë„ ì¸¡ì • ê²°ê³¼',
                yLabel: 'ê°€ì†ë„ (g)'
            };
            
            drawLineChart('accelChart', chartData);
        }

        // ë°ì´í„° ì €ì¥
        function saveAccelData() {
            const data = {
                info: {},
                measurements: []
            };
            
            // ê³„ì¸¡ ì •ë³´
            const infoForm = document.getElementById('accelInfoForm');
            const infoData = new FormData(infoForm);
            for (let [key, value] of infoData.entries()) {
                data.info[key] = value;
            }
            
            // ì¸¡ì • ë°ì´í„°
            for (let i = 1; i <= 5; i++) {
                const x = parseFloat(document.querySelector(`input[name="x${i}"]`).value) || 0;
                const y = parseFloat(document.querySelector(`input[name="y${i}"]`).value) || 0;
                const z = parseFloat(document.querySelector(`input[name="z${i}"]`).value) || 0;
                const resultText = document.getElementById(`result${i}`).textContent;
                const result = resultText !== '-' ? parseFloat(resultText) : 0;
                
                data.measurements.push({ x, y, z, result });
            }
            
            saveToStorage(STORAGE_KEYS.ACCELERATION_DATA, data);
            alert('ê°€ì†ë„ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ìë™ ì €ì¥
        function autoSaveAccelData() {
            const data = {
                info: {},
                measurements: []
            };
            
            const infoForm = document.getElementById('accelInfoForm');
            const infoData = new FormData(infoForm);
            for (let [key, value] of infoData.entries()) {
                data.info[key] = value;
            }
            
            for (let i = 1; i <= 5; i++) {
                const x = parseFloat(document.querySelector(`input[name="x${i}"]`).value) || 0;
                const y = parseFloat(document.querySelector(`input[name="y${i}"]`).value) || 0;
                const z = parseFloat(document.querySelector(`input[name="z${i}"]`).value) || 0;
                const resultText = document.getElementById(`result${i}`).textContent;
                const result = resultText !== '-' ? parseFloat(resultText) : 0;
                
                data.measurements.push({ x, y, z, result });
            }
            
            saveToStorage(STORAGE_KEYS.ACCELERATION_DATA, data);
        }

        // ë°ì´í„° ë¡œë“œ
        function loadAccelData() {
            const data = getFromStorage(STORAGE_KEYS.ACCELERATION_DATA);
            if (!data) return;
            
            // ê³„ì¸¡ ì •ë³´ ë¡œë“œ
            if (data.info) {
                Object.keys(data.info).forEach(key => {
                    const input = document.getElementById(key);
                    if (input) input.value = data.info[key];
                });
            }
            
            // ì¸¡ì • ë°ì´í„° ë¡œë“œ
            if (data.measurements) {
                data.measurements.forEach((m, i) => {
                    const index = i + 1;
                    const xInput = document.querySelector(`input[name="x${index}"]`);
                    const yInput = document.querySelector(`input[name="y${index}"]`);
                    const zInput = document.querySelector(`input[name="z${index}"]`);
                    
                    if (xInput) xInput.value = m.x;
                    if (yInput) yInput.value = m.y;
                    if (zInput) zInput.value = m.z;
                    
                    calculateResultant(index);
                });
                
                updateChart();
            }
        }
    </script>
</body>
</html>
