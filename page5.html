<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í’ˆì§ˆê´€ë¦¬ ì‹œìŠ¤í…œ - ë³€í˜•ë¥  ë°ì´í„°</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="header-title">Prefab í’ˆì§ˆê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <p class="header-subtitle">ë³€í˜•ë¥  ë°ì´í„° ì¸¡ì • ë° ë¶„ì„</p>
        </div>
    </header>

    <nav class="page-nav">
        <div class="container">
            <button onclick="window.location.href='index.html'" style="float: right; background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                ğŸ“‹ ë³´ê³ ì„œ ëª©ë¡
            </button>
            <ul>
                <li><a href="report.html">1. ì¢…í•© ìš”ì•½</a></li>
                <li><a href="page2.html">2. ìš´ì†¡ê²°ê³¼ ë¦¬í¬íŠ¸</a></li>
                <li><a href="page3.html">3. ê°€ì†ë„ ë°ì´í„°</a></li>
                <li><a href="page4.html">4. ê¸°ìš¸ê¸° ë°ì´í„°</a></li>
                <li><a href="page5.html" class="active">5. ë³€í˜•ë¥  ë°ì´í„°</a></li>
                <li><a href="page6.html">6. ë¶€ì¬ ì œì‘ ì˜¤ì°¨</a></li>
                <li><a href="dashboard.html">7. ì¢…í•© ëŒ€ì‹œë³´ë“œ</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <div class="alert alert-info">
            <strong>ğŸ“ ë³€í˜•ë¥  ê³„ì¸¡ ì•ˆë‚´</strong>
            <p style="margin-top: 0.5rem;">
                Prefab ë¶€ì¬ì˜ ì‘ë ¥ ìƒíƒœë¥¼ í™•ì¸í•˜ê¸° ìœ„í•œ ë³€í˜•ë¥  ì¸¡ì •ì…ë‹ˆë‹¤. (ë§ˆì´í¬ë¡œ ìŠ¤íŠ¸ë ˆì¸)
            </p>
            <div style="margin-top: 0.75rem; padding: 0.5rem; background-color: white; border-radius: 0.25rem;">
                <strong>í‰ê°€ ê¸°ì¤€:</strong><br>
                <span style="color: #10b981;">âœ“ ì •ìƒ: 60Î¼Îµ ë¯¸ë§Œ</span> | 
                <span style="color: #f59e0b;">âš  ì£¼ì˜: 60~80Î¼Îµ</span> | 
                <span style="color: #f97316;">âš ï¸ ê²½ê³ : 80~130Î¼Îµ</span> | 
                <span style="color: #ef4444;">âŒ ìœ„í—˜: 130Î¼Îµ ì´ˆê³¼</span>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ê³„ì¸¡ ì •ë³´</h2>
            </div>
            <div class="card-body">
                <form id="strainInfoForm">
                    <div class="info-grid">
                        <div class="info-item">
                            <label class="info-label">ì¸¡ì • ë‹¨ê³„ (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" name="strainPhase" value="ìš´ì†¡ì „" style="width: auto; cursor: pointer;">
                                    <span>ìš´ì†¡ì „</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" name="strainPhase" value="ìš´ì†¡ì¤‘" style="width: auto; cursor: pointer;">
                                    <span>ìš´ì†¡ì¤‘</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" name="strainPhase" value="ìš´ì†¡í›„" style="width: auto; cursor: pointer;">
                                    <span>ìš´ì†¡í›„</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" name="strainPhase" value="ìš´ì†¡ì „-ìš´ì†¡ì¤‘-ìš´ì†¡í›„" style="width: auto; cursor: pointer;">
                                    <span>ìš´ì†¡ì „-ìš´ì†¡ì¤‘-ìš´ì†¡í›„</span>
                                </label>
                            </div>
                        </div>
                        <div class="info-item">
                            <label class="info-label" for="strainDevice">ì¸¡ì • ì¥ë¹„</label>
                            <input type="text" id="strainDevice" name="strainDevice" class="info-value" 
                                   placeholder="ì˜ˆ: ë””ì§€í„¸ ê²½ì‚¬ê³„" required>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ë³€í˜•ë¥  ì¸¡ì • ë°ì´í„°</h2>
                <p class="card-description">ê° ì„¼ì„œ ìœ„ì¹˜ì˜ ë³€í˜•ë¥ ì„ ì…ë ¥í•˜ì„¸ìš” (ë‹¨ìœ„: Î¼Îµ)</p>
            </div>
            <div class="card-body">
                <table>
                    <thead>
                        <tr>
                            <th>ì„¼ì„œ ìœ„ì¹˜</th>
                            <th>ì´ˆê¸°ê°’ (Î¼Îµ)</th>
                            <th>ì¸¡ì •ê°’ (Î¼Îµ)</th>
                            <th>ë³€í™”ëŸ‰ (Î¼Îµ)</th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ì¸¡ì 1</td>
                            <td><input type="number" step="1" name="strainInit1" class="strain-input" onchange="calculateStrainChange(1)"></td>
                            <td><input type="number" step="1" name="strainMeas1" class="strain-input" onchange="calculateStrainChange(1)"></td>
                            <td id="strainChange1">-</td>
                            <td id="strainStatus1">-</td>
                        </tr>
                        <tr>
                            <td>ì¸¡ì 2</td>
                            <td><input type="number" step="1" name="strainInit2" class="strain-input" onchange="calculateStrainChange(2)"></td>
                            <td><input type="number" step="1" name="strainMeas2" class="strain-input" onchange="calculateStrainChange(2)"></td>
                            <td id="strainChange2">-</td>
                            <td id="strainStatus2">-</td>
                        </tr>
                        <tr>
                            <td>ì¸¡ì 3</td>
                            <td><input type="number" step="1" name="strainInit3" class="strain-input" onchange="calculateStrainChange(3)"></td>
                            <td><input type="number" step="1" name="strainMeas3" class="strain-input" onchange="calculateStrainChange(3)"></td>
                            <td id="strainChange3">-</td>
                            <td id="strainStatus3">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ë³€í˜•ë¥  ë¶„í¬ ê·¸ë˜í”„</h2>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="strainChart"></canvas>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="updateStrainChart()">ğŸ“ˆ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸</button>
                </div>
            </div>
        </div>

        <!-- ì „ì²´ ë³€í˜•ë¥  ê·¸ë˜í”„ ì´ë¯¸ì§€ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ì „ì²´ ë³€í˜•ë¥  ê·¸ë˜í”„</h2>
                <p class="card-description">ì „ì²´ ë³€í˜•ë¥  ë°ì´í„° ê·¸ë˜í”„ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            </div>
            <div class="card-body">
                <div class="photo-upload-container">
                    <div class="photo-upload" id="strainGraphPreview" onclick="console.log('ğŸ“Š ì—…ë¡œë“œ ì˜ì—­ í´ë¦­ë¨'); document.getElementById('strainGraphInput').click();" style="cursor: pointer;">
                        <input type="file" id="strainGraphInput" accept="image/*" style="display: none;" onchange="console.log('ğŸ“ íŒŒì¼ ì„ íƒë¨:', this.files[0]?.name); handleStrainGraphImageUpload(this);">
                        <span class="placeholder">ğŸ“Š í´ë¦­í•˜ì—¬ ê·¸ë˜í”„ ì´ë¯¸ì§€ ì—…ë¡œë“œ</span>
                    </div>
                </div>
                <div class="mt-3" style="text-align: center;">
                    <button class="btn btn-secondary" onclick="clearStrainGraph()" style="margin-right: 10px;">ğŸ—‘ï¸ ì´ë¯¸ì§€ ì‚­ì œ</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ì¸¡ì • ê²°ê³¼ ìš”ì•½</h2>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ìµœëŒ€ ë³€í˜•ë¥ </div>
                        <div class="stat-value" id="maxStrain">0 Î¼Îµ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">í‰ê·  ë³€í˜•ë¥ </div>
                        <div class="stat-value" id="avgStrain">0 Î¼Îµ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì´ˆê³¼ ì„¼ì„œ</div>
                        <div class="stat-value" id="strainExceedCount">0 ê°œ</div>
                    </div>
                    <div class="stat-card" id="strainFinalStatus">
                        <div class="stat-label">ì¢…í•© í‰ê°€</div>
                        <div class="stat-value">ëŒ€ê¸°ì¤‘</div>
                    </div>
                </div>
                <div id="strainResultAlert" class="mt-3"></div>
            </div>
        </div>

        <div class="nav-buttons">
            <a href="page4.html" class="btn btn-secondary">â† ì´ì „: ê¸°ìš¸ê¸° ë°ì´í„°</a>
            <button class="btn btn-success" onclick="saveStrainData()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
            <a href="page6.html" class="btn btn-primary">ë‹¤ìŒ: ë¶€ì¬ ì œì‘ ì˜¤ì°¨ â†’</a>
        </div>
    </main>

    <!-- Load script.js before inline scripts -->
    <script src="assets/js/script.js"></script>

    <script>
        // ë³€í˜•ë¥  ì„ê³„ê°’ (Î¼Îµ) - 4ë‹¨ê³„ í‰ê°€
        const STRAIN_NORMAL = 60;    // ì •ìƒ
        const STRAIN_CAUTION = 80;   // ì£¼ì˜
        const STRAIN_WARNING = 130;  // ê²½ê³ 
        // 130 ì´ˆê³¼ëŠ” ìœ„í—˜

        document.addEventListener('DOMContentLoaded', function() {
            loadStrainData();

            // ì „ì²´ ë³€í˜•ë¥  ê·¸ë˜í”„ ì´ë¯¸ì§€ ë¡œë“œ
            loadStrainGraphImage();

            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('strainDate').value = now.toISOString().slice(0, 16);

            document.querySelectorAll('.strain-input').forEach(input => {
                input.addEventListener('change', autoSaveStrainData);
            });
            
            autoSaveForm('strainInfoForm', STORAGE_KEYS.STRAIN_DATA);
        });

        function calculateStrainChange(index) {
            const initInput = document.querySelector(`input[name="strainInit${index}"]`);
            const measInput = document.querySelector(`input[name="strainMeas${index}"]`);
            
            const init = parseFloat(initInput.value) || 0;
            const meas = parseFloat(measInput.value) || 0;
            const change = meas - init;
            
            document.getElementById(`strainChange${index}`).textContent = change.toFixed(0) + ' Î¼Îµ';
            
            const statusCell = document.getElementById(`strainStatus${index}`);
            const absChange = Math.abs(change);
            if (absChange > STRAIN_WARNING) {
                statusCell.innerHTML = '<span class="badge badge-danger">ìœ„í—˜</span>';
            } else if (absChange >= STRAIN_CAUTION) {
                statusCell.innerHTML = '<span class="badge" style="background-color: #f97316; color: white;">ê²½ê³ </span>';
            } else if (absChange >= STRAIN_NORMAL) {
                statusCell.innerHTML = '<span class="badge badge-warning">ì£¼ì˜</span>';
            } else if (change !== 0) {
                statusCell.innerHTML = '<span class="badge badge-success">ì •ìƒ</span>';
            } else {
                statusCell.textContent = '-';
            }
            
            updateStrainStatistics();
        }

        function updateStrainStatistics() {
            const changes = [];
            for (let i = 1; i <= 3; i++) {
                const changeText = document.getElementById(`strainChange${i}`).textContent;
                if (changeText !== '-') {
                    changes.push(Math.abs(parseFloat(changeText)));
                }
            }
            
            if (changes.length === 0) return;
            
            const max = Math.max(...changes);
            const avg = changes.reduce((a, b) => a + b, 0) / changes.length;
            
            // 3ë‹¨ê³„ í‰ê°€ ì¹´ìš´íŠ¸
            const dangerCount = changes.filter(c => c > STRAIN_WARNING).length;
            const warningCount = changes.filter(c => c >= STRAIN_CAUTION && c <= STRAIN_WARNING).length;
            const cautionCount = changes.filter(c => c >= STRAIN_NORMAL && c < STRAIN_CAUTION).length;
            const normalCount = changes.filter(c => c < STRAIN_NORMAL).length;
            
            document.getElementById('maxStrain').textContent = max.toFixed(0) + ' Î¼Îµ';
            document.getElementById('avgStrain').textContent = avg.toFixed(0) + ' Î¼Îµ';
            document.getElementById('strainExceedCount').textContent = dangerCount + ' ê°œ';
            
            const finalStatus = document.getElementById('strainFinalStatus');
            const resultAlert = document.getElementById('strainResultAlert');
            
            if (dangerCount > 0) {
                finalStatus.className = 'stat-card danger';
                finalStatus.querySelector('.stat-value').textContent = 'ìœ„í—˜';
                resultAlert.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>âŒ ìœ„í—˜ ìˆ˜ì¤€</strong><br>
                        ${dangerCount}ê°œ ì„¼ì„œê°€ ìœ„í—˜ ê¸°ì¤€(130Î¼Îµ)ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </div>
                `;
            } else if (warningCount > 0) {
                finalStatus.className = 'stat-card';
                finalStatus.style.backgroundColor = '#f97316';
                finalStatus.style.color = 'white';
                finalStatus.querySelector('.stat-value').textContent = 'ê²½ê³ ';
                resultAlert.innerHTML = `
                    <div class="alert" style="background-color: #fff7ed; border-color: #f97316; color: #9a3412;">
                        <strong>âš ï¸ ê²½ê³  ìˆ˜ì¤€</strong><br>
                        ${warningCount}ê°œ ì„¼ì„œê°€ ê²½ê³  ë²”ìœ„(80~130Î¼Îµ)ì…ë‹ˆë‹¤. ë©´ë°€í•œ ëª¨ë‹ˆí„°ë§ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </div>
                `;
            } else if (cautionCount > 0) {
                finalStatus.className = 'stat-card warning';
                finalStatus.querySelector('.stat-value').textContent = 'ì£¼ì˜';
                resultAlert.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>âš  ì£¼ì˜ í•„ìš”</strong><br>
                        ${cautionCount}ê°œ ì„¼ì„œê°€ ì£¼ì˜ ë²”ìœ„(60~80Î¼Îµ)ì…ë‹ˆë‹¤. ì§€ì†ì ì¸ ê´€ì°°ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </div>
                `;
            } else {
                finalStatus.className = 'stat-card success';
                finalStatus.querySelector('.stat-value').textContent = 'ì •ìƒ';
                resultAlert.innerHTML = `
                    <div class="alert alert-success">
                        <strong>âœ… ì •ìƒ ë²”ìœ„</strong><br>
                        ëª¨ë“  ì„¼ì„œì˜ ë³€í˜•ë¥ ì´ ì •ìƒ ë²”ìœ„(60Î¼Îµ ë¯¸ë§Œ)ì…ë‹ˆë‹¤.
                    </div>
                `;
            }
        }

        function updateStrainChart() {
            const labels = ['ì¸¡ì 1', 'ì¸¡ì 2', 'ì¸¡ì 3'];
            const values = [];
            const colors = [];
            
            for (let i = 1; i <= 3; i++) {
                const changeText = document.getElementById(`strainChange${i}`).textContent;
                if (changeText !== '-') {
                    const value = Math.abs(parseFloat(changeText));
                    values.push(value);
                    // 3ë‹¨ê³„ í‰ê°€ ìƒ‰ìƒ
                    if (value > STRAIN_WARNING) {
                        colors.push('#ef4444'); // ìœ„í—˜
                    } else if (value >= STRAIN_CAUTION) {
                        colors.push('#f97316'); // ê²½ê³ 
                    } else if (value >= STRAIN_NORMAL) {
                        colors.push('#f59e0b'); // ì£¼ì˜
                    } else {
                        colors.push('#10b981'); // ì •ìƒ
                    }
                } else {
                    values.push(0);
                    colors.push('#9ca3af');
                }
            }
            
            drawBarChart('strainChart', {
                labels: labels,
                values: values,
                colors: colors,
                thresholds: {
                    upper: STRAIN_WARNING,
                    warning: STRAIN_CAUTION,
                    caution: STRAIN_NORMAL
                },
                title: 'ì„¼ì„œë³„ ë³€í˜•ë¥  ì¸¡ì • ê²°ê³¼',
                yLabel: 'ë³€í˜•ë¥  (Î¼Îµ)'
            });
        }

        function saveStrainData() {
            const data = {
                info: {},
                measurements: []
            };
            
            const infoForm = document.getElementById('strainInfoForm');
            const infoData = new FormData(infoForm);
            for (let [key, value] of infoData.entries()) {
                data.info[key] = value;
            }
            
            for (let i = 1; i <= 3; i++) {
                const init = parseFloat(document.querySelector(`input[name="strainInit${i}"]`).value) || 0;
                const meas = parseFloat(document.querySelector(`input[name="strainMeas${i}"]`).value) || 0;
                const changeText = document.getElementById(`strainChange${i}`).textContent;
                const change = changeText !== '-' ? parseFloat(changeText) : 0;
                
                data.measurements.push({ init, meas, change });
            }
            
            saveToStorage(STORAGE_KEYS.STRAIN_DATA, data);
            alert('ë³€í˜•ë¥  ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function autoSaveStrainData() {
            const data = {
                info: {},
                measurements: []
            };
            
            const infoForm = document.getElementById('strainInfoForm');
            const infoData = new FormData(infoForm);
            for (let [key, value] of infoData.entries()) {
                data.info[key] = value;
            }
            
            for (let i = 1; i <= 3; i++) {
                const init = parseFloat(document.querySelector(`input[name="strainInit${i}"]`).value) || 0;
                const meas = parseFloat(document.querySelector(`input[name="strainMeas${i}"]`).value) || 0;
                const changeText = document.getElementById(`strainChange${i}`).textContent;
                const change = changeText !== '-' ? parseFloat(changeText) : 0;
                
                data.measurements.push({ init, meas, change });
            }
            
            saveToStorage(STORAGE_KEYS.STRAIN_DATA, data);
        }

        function loadStrainData() {
            const data = getFromStorage(STORAGE_KEYS.STRAIN_DATA);
            if (!data) return;
            
            if (data.info) {
                Object.keys(data.info).forEach(key => {
                    const input = document.getElementById(key);
                    if (input) input.value = data.info[key];
                });
            }
            
            if (data.measurements) {
                data.measurements.forEach((m, i) => {
                    const index = i + 1;
                    const initInput = document.querySelector(`input[name="strainInit${index}"]`);
                    const measInput = document.querySelector(`input[name="strainMeas${index}"]`);
                    
                    if (initInput) initInput.value = m.init;
                    if (measInput) measInput.value = m.meas;
                    
                    calculateStrainChange(index);
                });
                
                updateStrainChart();
            }
        }

        // ì „ì²´ ë³€í˜•ë¥  ê·¸ë˜í”„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleStrainGraphImageUpload(input) {
            console.log('ğŸ¯ handleStrainGraphImageUpload í•¨ìˆ˜ í˜¸ì¶œë¨');
            
            const file = input.files[0];
            if (!file) {
                console.log('âŒ íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                return;
            }
            
            console.log('=== ì „ì²´ ë³€í˜•ë¥  ê·¸ë˜í”„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘ ===');
            console.log('íŒŒì¼ëª…:', file.name);
            console.log('íŒŒì¼ í¬ê¸°:', (file.size / 1024).toFixed(2), 'KB');
            console.log('íŒŒì¼ íƒ€ì…:', file.type);
            
            // ì´ë¯¸ì§€ íŒŒì¼ì¸ì§€ í™•ì¸
            if (!file.type.startsWith('image/')) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            // resizeAndCompressImage í•¨ìˆ˜ ì¡´ì¬ í™•ì¸
            if (typeof resizeAndCompressImage === 'undefined') {
                console.error('âŒ resizeAndCompressImage í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
                alert('ì´ë¯¸ì§€ ì²˜ë¦¬ í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            console.log('âœ… resizeAndCompressImage í•¨ìˆ˜ ì°¾ìŒ, ì••ì¶• ì‹œì‘');
            
            // ì´ë¯¸ì§€ ì••ì¶• ë° ì €ì¥
            resizeAndCompressImage(
                file,
                110, // ëª©í‘œ í¬ê¸° (KB)
                0.9, // ì´ˆê¸° í’ˆì§ˆ
                function(compressedDataUrl) {
                    console.log('âœ… ì••ì¶• ì„±ê³µ, ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ');
                    
                    // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                    const preview = document.getElementById('strainGraphPreview');
                    preview.innerHTML = `
                        <input type="file" id="strainGraphInput" accept="image/*" style="display: none;" onchange="handleStrainGraphImageUpload(this)">
                        <img src="${compressedDataUrl}" alt="ì „ì²´ ë³€í˜•ë¥  ê·¸ë˜í”„" style="max-width: 100%; height: auto; display: block;">
                    `;
                    preview.classList.add('has-image');
                    preview.onclick = null; // ì´ë¯¸ì§€ê°€ í‘œì‹œë˜ë©´ í´ë¦­ ì´ë²¤íŠ¸ ì œê±°
                    
                    // LocalStorageì— ì €ì¥
                    saveToStorage(STORAGE_KEYS.STRAIN_GRAPH_IMAGE, compressedDataUrl);
                    
                    console.log('ğŸ’¾ ì „ì²´ ë³€í˜•ë¥  ê·¸ë˜í”„ ì´ë¯¸ì§€ ì €ì¥ ì™„ë£Œ');
                    alert('âœ… ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
                },
                function(error) {
                    console.error('âŒ ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨:', error);
                    alert('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            );
        }

        // ì „ì²´ ë³€í˜•ë¥  ê·¸ë˜í”„ ì´ë¯¸ì§€ ë¡œë“œ
        function loadStrainGraphImage() {
            console.log('ğŸ“‚ ì „ì²´ ë³€í˜•ë¥  ê·¸ë˜í”„ ì´ë¯¸ì§€ ë¡œë“œ ì‹œë„');
            const imageData = getFromStorage(STORAGE_KEYS.STRAIN_GRAPH_IMAGE);
            
            if (imageData) {
                console.log('âœ… ì €ì¥ëœ ì´ë¯¸ì§€ ë°œê²¬, í¬ê¸°:', (imageData.length / 1024).toFixed(2), 'KB');
                const preview = document.getElementById('strainGraphPreview');
                if (preview) {
                    preview.innerHTML = `
                        <input type="file" id="strainGraphInput" accept="image/*" style="display: none;" onchange="handleStrainGraphImageUpload(this)">
                        <img src="${imageData}" alt="ì „ì²´ ë³€í˜•ë¥  ê·¸ë˜í”„" style="max-width: 100%; height: auto; display: block;">
                    `;
                    preview.classList.add('has-image');
                    preview.onclick = null; // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ í´ë¦­ ì´ë²¤íŠ¸ ì œê±°
                    console.log('âœ… ì „ì²´ ë³€í˜•ë¥  ê·¸ë˜í”„ ì´ë¯¸ì§€ í‘œì‹œ ì™„ë£Œ');
                } else {
                    console.error('âŒ strainGraphPreview ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
            } else {
                console.log('â„¹ï¸ ì €ì¥ëœ ì „ì²´ ë³€í˜•ë¥  ê·¸ë˜í”„ ì´ë¯¸ì§€ ì—†ìŒ');
            }
        }

        // ì „ì²´ ë³€í˜•ë¥  ê·¸ë˜í”„ ì´ë¯¸ì§€ ì‚­ì œ
        function clearStrainGraph() {
            if (!confirm('ì „ì²´ ë³€í˜•ë¥  ê·¸ë˜í”„ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            console.log('ğŸ—‘ï¸ ì „ì²´ ë³€í˜•ë¥  ê·¸ë˜í”„ ì´ë¯¸ì§€ ì‚­ì œ ì‹œì‘');
            
            const preview = document.getElementById('strainGraphPreview');
            preview.innerHTML = `
                <input type="file" id="strainGraphInput" accept="image/*" style="display: none;" onchange="handleStrainGraphImageUpload(this)">
                <span class="placeholder">ğŸ“Š í´ë¦­í•˜ì—¬ ê·¸ë˜í”„ ì´ë¯¸ì§€ ì—…ë¡œë“œ</span>
            `;
            preview.classList.remove('has-image');
            preview.onclick = function() { document.getElementById('strainGraphInput').click(); };
            
            // LocalStorageì—ì„œ ì‚­ì œ
            localStorage.removeItem(getStorageKey('STRAIN_GRAPH_IMAGE'));
            
            console.log('âœ… ì „ì²´ ë³€í˜•ë¥  ê·¸ë˜í”„ ì´ë¯¸ì§€ ì‚­ì œ ì™„ë£Œ');
            alert('âœ… ì´ë¯¸ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    </script>
</body>
</html>
